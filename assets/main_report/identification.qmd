---
params:
    group: "xan_test"
    refs: "22_331_assembly"
    samp_data: "_test_data/metadata_medium.csv"
    ref_data: "_test_data/merged_assembly_stats.tsv"
    sendsketch: "_test_data/sendsketch"
    variant_data: "_test_data/variant_data"
    ani_matrix: "_test_data/xan_test_comp.csv"
    core_phylo: "_test_data/xan_test.treefile"
    multiqc: "_test_data/multiqc"
    quast: "_test_data/quast"
    versions: "_test_data/software_versions.yml"
execute:
  echo: false
---

```{r load_libraries, warning=FALSE, message=FALSE, file='load_libraries.R'}
# When running manually for development: source('load_libraries.R')
```

```{r parse_inputs, file='parse_inputs.R'}
# When running manually for development: source('parse_inputs.R')
```

# Identification

```{r id_setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 10, warning = FALSE)
```

```{r id_libraries}
library(phylocanvas)
library(ape)
library(magrittr)
library(pheatmap)
```

```{r id_parse_inputs}
ref_data$modified_id <- gsub(ref_data$LastMajorReleaseAccession, pattern = ".", replacement = "_", fixed = TRUE)
samp_data$modified_id <- paste0(gsub(samp_data$sample, pattern = "-", replacement = "_", fixed = TRUE), "_T1")
ani_matrix <-  read.csv(params$ani_matrix, sep = ',', check.names = FALSE)
core_tree <- ape::read.tree(params$core_phylo)
snp_trees <- ape::read.tree(params$snp_phylos)
```

## Sendsketch

A table with sendsketch results

### Initial ANI heatmap and dendrogram

*Martha-Not sure if this is useful, but one idea. The interactive version wasn't that useful-but maybe other options*

```{r ANI dendrogram, fig.height = 8, fig.width=8}
library(pheatmap)
row.names(ani_matrix) <- colnames(ani_matrix)
p1 <- pheatmap(ani_matrix, show_rownames = T, labels_row = colnames(ani_matrix))
p1
```

## Core genome phylogeny

```{r id_core_phylo, fig.height = 7, eval = ! is.null(core_tree)}
# Identify which tips are samples and references
sample_ids <- core_tree$tip.label[core_tree$tip.label %in% samp_data$modified_id]

# Root tree 
colnames(ani_matrix) <- gsub(colnames(ani_matrix), pattern = "[.-]", replacement = "_")
rownames(ani_matrix) <- colnames(ani_matrix)
group_ani <- ani_matrix[rownames(ani_matrix) %in% core_tree$tip.label, colnames(ani_matrix) %in% core_tree$tip.label]
#core_tree <- root(core_tree, names(which.min(colMeans(group_ani[sample_ids, ]))))

# Set tip labels to taxon names for reference sequences
# TODO: need a more reliable way to get IDs
name_key <- c(
  ref_data$Organism, 
  samp_data$sample
)
names(name_key) <- c(
  ref_data$modified_id,
  samp_data$modified_id
)
core_tree$tip.label <- name_key[core_tree$tip.label]

# Plot tree
phycanv <- phylocanvas(core_tree, treetype = "rectangular", alignlabels = T, showscalebar = T, width = "100%")
for (x in name_key[sample_ids]) {
  phycanv <- style_node(phycanv, x, labelcolor = "green", labeltextsize = 30)
}
    
phycanv
```

```{asis id_no_core_phylo, echo = is.null(core_tree)}
There is no tree to draw, probably because there were too few samples.
More info will be added later.
```
